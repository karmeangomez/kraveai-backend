name: ğŸš€ Despliegue Seguro KraveAI

on:
  push:
    branches:
      - main

jobs:
  build-and-deploy:
    name: ğŸ” Despliegue en Raspberry Pi
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“… Clonar Repositorio
        uses: actions/checkout@v3

      - name: ğŸ” Crear Archivo .env.temp
        run: |
          mkdir -p secure_config
          echo "IONOS_EMAIL=${{ secrets.IONOS_EMAIL }}" > secure_config/.env.temp
          echo "IONOS_PASSWORD=${{ secrets.IONOS_PASSWORD }}" >> secure_config/.env.temp
          echo "IONOS_USER=${{ secrets.IONOS_USER }}" >> secure_config/.env.temp
          echo "IONOS_PASS=${{ secrets.IONOS_PASS }}" >> secure_config/.env.temp
          echo "CRYPTO_KEY=${{ secrets.CRYPTO_KEY }}" >> secure_config/.env.temp
          echo "CRYPTO_IV=${{ secrets.CRYPTO_IV }}" >> secure_config/.env.temp
          echo "MAILBOXVALIDATOR_KEY=${{ secrets.MAILBOXVALIDATOR_KEY }}" >> secure_config/.env.temp
          echo "TELEGRAM_BOT_TOKEN=${{ secrets.TELEGRAM_BOT_TOKEN }}" >> secure_config/.env.temp
          echo "TELEGRAM_CHAT_ID=${{ secrets.TELEGRAM_CHAT_ID }}" >> secure_config/.env.temp
          # AÃ±adimos la clave de Webshare
          echo "WEBSHARE_API_KEY=${{ secrets.WEBSHARE_API_KEY }}" >> secure_config/.env.temp

      - name: ğŸ”’ Cifrar .env.temp como .env.enc
        run: |
          node src/utils/secureEnv.js encrypt \
            --input secure_config/.env.temp \
            --output secure_config/.env.enc \
            --key "${{ secrets.CRYPTO_KEY }}" \
            --iv "${{ secrets.CRYPTO_IV }}"
          rm secure_config/.env.temp
          echo "âœ… .env.enc generado"

      - name: ğŸš€ Subir .env.enc a Raspberry Pi (SCP)
        uses: appleboy/scp-action@v0.1.5
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: ${{ secrets.SSH_PORT }}
          source: secure_config/.env.enc
          target: ~/kraveai-backend/

      - name: ğŸ“° Ejecutar Despliegue Seguro (SSH)
        uses: appleboy/ssh-action@v1
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: ${{ secrets.SSH_PORT }}
          script: |
            echo "ğŸ“¦ Iniciando despliegue..."
            cd ~/kraveai-backend
            git fetch --all
            git reset --hard origin/main

            echo "ğŸ”“ Descifrando .env..."
            node src/utils/secureEnv.js decrypt \
              --input .env.enc \
              --output .env \
              --key "${{ secrets.CRYPTO_KEY }}" \
              --iv "${{ secrets.CRYPTO_IV }}"

            echo "ğŸ§ª Verificando variables de entorno..."
            node src/utils/checkEnv.js

            echo "ğŸ”‘ Validando variables..."
            # AÃ±adimos WEBSHARE_API_KEY a la lista de variables a verificar
            for var in \
              IONOS_EMAIL \
              IONOS_PASSWORD \
              IONOS_USER \
              IONOS_PASS \
              CRYPTO_KEY \
              CRYPTO_IV \
              MAILBOXVALIDATOR_KEY \
              TELEGRAM_BOT_TOKEN \
              TELEGRAM_CHAT_ID \
              WEBSHARE_API_KEY; do
              if [ -z "$(grep $var .env)" ]; then
                echo "âŒ Error: $var no encontrada en .env"
                exit 1
              else
                echo "âœ… $var configurada correctamente"
              fi
            done

            echo "ğŸ”„ Actualizando proxies de Webshare..."
            node -e "import('./src/proxies/webshareApi.js').then(m => m.default.refreshProxies().catch(e => { console.error(e); process.exit(1); }))"
            
            echo "ğŸ”€ Reiniciando servicios..."
            sudo systemctl restart kraveai-python.service
            sudo systemctl restart crear-cuentas.service

            echo "ğŸŒ Verificando tÃºnel Cloudflare..."
            estado=$(systemctl is-active cloudflared.service)
            if [ "$estado" != "active" ]; then
              echo "TÃºnel inactivo. Reiniciando..."
              sudo systemctl restart cloudflared.service
            else
              echo "âœ… TÃºnel activo"
            fi

            echo "ğŸªº Verificando /health..."
            respuesta=$(curl -s http://localhost:8000/health || echo "")
            echo "Respuesta: $respuesta"

            if echo "$respuesta" | grep -q "\"status\": \"OK\""; then
              mensaje="âœ… *KraveAI actualizado con Ã©xito*\nğŸ•’ $(date '+%H:%M')\nğŸ” ConfiguraciÃ³n segura activa\nğŸŸ¢ Backend OK\nğŸ”„ Proxies actualizados"
              status=0
            else
              mensaje="âš ï¸ *Error en despliegue KraveAI*\nğŸ”´ /health fallÃ³\nğŸ•’ $(date '+%H:%M')\nRevisar: journalctl -u kraveai-python.service"
              status=1
            fi

            echo "ğŸ“¨ Enviando alerta a Telegram..."
            curl -s -X POST https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendMessage \
              -d chat_id=${{ secrets.TELEGRAM_CHAT_ID }} \
              -d text="$mensaje" \
              -d parse_mode=Markdown

            exit $status