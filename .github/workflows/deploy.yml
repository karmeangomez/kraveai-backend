name: üöÄ Despliegue Seguro KraveAI

on:
  push:
    branches:
      - main

jobs:
  deploy:
    name: üîê Despliegue en Raspberry Pi
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: üìÖ Clonar Repositorio
        uses: actions/checkout@v4

      - name: üîê Preparar variables de entorno
        shell: bash
        run: |
          mkdir -p secure_config
          # Generar archivo .env.temp con todas las variables
          {
            echo "IONOS_EMAIL=${{ secrets.IONOS_EMAIL }}"
            echo "IONOS_PASSWORD=${{ secrets.IONOS_PASSWORD }}"
            echo "IONOS_USER=${{ secrets.IONOS_USER }}"
            echo "IONOS_PASS=${{ secrets.IONOS_PASS }}"
            echo "CRYPTO_KEY=${{ secrets.CRYPTO_KEY }}"
            echo "CRYPTO_IV=${{ secrets.CRYPTO_IV }}"
            echo "MAILBOXVALIDATOR_KEY=${{ secrets.MAILBOXVALIDATOR_KEY }}"
            echo "TELEGRAM_BOT_TOKEN=${{ secrets.TELEGRAM_BOT_TOKEN }}"
            echo "TELEGRAM_CHAT_ID=${{ secrets.TELEGRAM_CHAT_ID }}"
            
            # Procesar WEBSHARE_API_KEY para eliminar espacios
            WEBSHARE_API_KEY=$(echo -n "${{ secrets.WEBSHARE_API_KEY }}" | tr -d '[:space:]')
            echo "WEBSHARE_API_KEY=$WEBSHARE_API_KEY"
          } > secure_config/.env.temp
          
          # Verificar longitud de WEBSHARE_API_KEY
          WEB_KEY_LEN=$(grep 'WEBSHARE_API_KEY' secure_config/.env.temp | cut -d= -f2 | wc -c)
          echo "‚ÑπÔ∏è Longitud WEBSHARE_API_KEY: $WEB_KEY_LEN caracteres"

      - name: üîí Cifrar variables
        run: |
          node src/utils/secureEnv.js encrypt \
            --input secure_config/.env.temp \
            --output secure_config/.env.enc \
            --key "${{ secrets.CRYPTO_KEY }}" \
            --iv "${{ secrets.CRYPTO_IV }}"
          
          # Destruir archivo temporal de forma segura
          shred -u -z -n 3 secure_config/.env.temp
          echo "‚úÖ Archivo .env.enc generado"

      - name: üöÄ Transferir a Raspberry Pi
        uses: appleboy/scp-action@v0.1.5
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: ${{ secrets.SSH_PORT }}
          source: secure_config/.env.enc
          target: ~/kraveai-backend/
          overwrite: true

      - name: üõ† Ejecutar despliegue
        uses: appleboy/ssh-action@v1
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: ${{ secrets.SSH_PORT }}
          script: |
            set -e  # Salir inmediatamente en error
            
            echo "üì¶ Iniciando despliegue en $(hostname)"
            cd ~/kraveai-backend
            
            # Sincronizar c√≥digo
            git fetch origin main
            git reset --hard origin/main
            npm install --omit=dev
            
            # Descifrar variables
            echo "üîì Descifrando .env..."
            node src/utils/secureEnv.js decrypt \
              --input .env.enc \
              --output .env \
              --key "${{ secrets.CRYPTO_KEY }}" \
              --iv "${{ secrets.CRYPTO_IV }}"
            
            # Verificar variables cr√≠ticas
            echo "üîç Validando variables:"
            for var in WEBSHARE_API_KEY TELEGRAM_BOT_TOKEN TELEGRAM_CHAT_ID; do
              value=$(grep "^$var=" .env | cut -d= -f2-)
              len=${#value}
              
              if [ $len -lt 10 ]; then
                echo "‚ùå ERROR: $var tiene solo $len caracteres (muy corta)"
                exit 1
              else
                echo "‚úÖ $var: $len caracteres"
              fi
            done
            
            # Actualizar proxies
            echo "üîÑ Actualizando proxies de Webshare..."
            export NODE_OPTIONS="--no-warnings"
            node -e "import('./src/proxies/webshareApi.js').then(m => m.default.refreshProxies().catch(e => { 
              console.error('‚ùå Error cr√≠tico:', e); 
              process.exit(1);
            }))"
            
            # Reiniciar servicios
            echo "üîÅ Reiniciando servicios..."
            sudo systemctl restart kraveai-python.service
            sudo systemctl restart crear-cuentas.service
            
            # Verificar t√∫nel Cloudflare
            echo "üåê Estado t√∫nel Cloudflare:"
            if sudo systemctl is-active --quiet cloudflared.service; then
              echo "‚úÖ T√∫nel activo"
            else
              echo "‚ö†Ô∏è Reiniciando t√∫nel inactivo"
              sudo systemctl restart cloudflared.service
              sleep 5
              sudo systemctl status cloudflared.service --no-pager
            fi
            
            # Verificar salud del backend
            echo "ü©∫ Verificando salud del backend..."
            HEALTH_RESPONSE=$(curl -sSf http://localhost:8000/health || echo '{"status":"ERROR"}')
            echo "Respuesta: $HEALTH_RESPONSE"
            
            if echo "$HEALTH_RESPONSE" | grep -q '"status":"OK"'; then
              mensaje="‚úÖ *KraveAI actualizado con √©xito*\n‚Ä¢ Hora: $(date '+%H:%M')\n‚Ä¢ Proxies: Actualizados\n‚Ä¢ Backend: Funcionando"
              status=0
            else
              mensaje="‚ö†Ô∏è *Error en despliegue*\n‚Ä¢ Hora: $(date '+%H:%M')\n‚Ä¢ Problema: Health check fall√≥\n‚Ä¢ Acci√≥n: Revisar logs"
              status=1
            fi
            
            # Enviar notificaci√≥n a Telegram
            echo "üì® Enviando notificaci√≥n a Telegram..."
            source .env
            curl -X POST https://api.telegram.org/bot$TELEGRAM_BOT_TOKEN/sendMessage \
              -d chat_id="$TELEGRAM_CHAT_ID" \
              -d text="$mensaje" \
              -d parse_mode="Markdown" \
              --silent --show-error
            
            exit $status
