name: Deploy to Raspberry Pi with Telegram + Rollback

on:
  push:
    branches: [main]

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Deploy via SSH with Rollback
        uses: appleboy/ssh-action@v1
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            echo "ğŸ›¡ï¸ Iniciando backup"
            TIMESTAMP=$(date +%F-%H%M)
            BACKUP_DIR=~/kraveai-backend-backups/$TIMESTAMP
            mkdir -p $BACKUP_DIR
            cp -r ~/kraveai-backend/* $BACKUP_DIR

            echo "ğŸ“¥ Pulling latest code"
            cd ~/kraveai-backend
            git pull origin main

            echo "ğŸ Activando entorno"
            source env/bin/activate || python3 -m venv env
            source env/bin/activate

            echo "ğŸ“¦ Instalando dependencias"
            pip install -r requirements.txt

            echo "ğŸ”„ Reiniciando backend"
            sudo systemctl restart kraveai-python
            sleep 3

            echo "ğŸŒ Verificando backend"
            STATUS=$(curl -s http://localhost:8000/health || echo FAIL)
            BACKEND_OK=false
            if echo "$STATUS" | grep -q '"status":"OK"'; then
              BACKEND_OK=true
            else
              echo "âš ï¸ Backend sin respuesta, reiniciando tÃºnel Cloudflare"
              sudo systemctl restart cloudflared
              sleep 3
              STATUS=$(curl -s http://localhost:8000/health || echo FAIL)
              if echo "$STATUS" | grep -q '"status":"OK"'; then
                BACKEND_OK=true
              fi
            fi

            echo "ğŸ“Š Obteniendo mÃ©tricas"
            RAM=$(free -m | awk '/Mem:/ {print $3"MB"}')
            CPU=$(top -bn1 | grep Cpu | awk '{print $2"%"}')

            echo "ğŸ“ Registrando log"
            echo "[$TIMESTAMP] Deploy ejecutado" >> ~/kraveai-backend/deploy.log

            if [ "$BACKEND_OK" = true ]; then
              MSG="âœ… *KraveAI desplegado correctamente*%0AğŸŒ https://api.kraveapi.xyz/health%0AğŸ§  RAM: $RAM | ğŸ”¥ CPU: $CPU"
            else
              echo "ğŸ” Iniciando rollback"
              cp -r $BACKUP_DIR/* ~/kraveai-backend/
              sudo systemctl restart kraveai-python
              sleep 3
              MSG="âŒ *Deploy fallido. Rollback ejecutado.*%0AğŸš¨ Revisar backend en Raspberry"
            fi

            echo "ğŸ“² Enviando Telegram"
            curl -s -X POST "https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendMessage" \
              -d chat_id="${{ secrets.TELEGRAM_CHAT_ID }}" \
              -d text="$MSG" \
              -d parse_mode="Markdown"
