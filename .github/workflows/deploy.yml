name: ğŸš€ Despliegue AutomÃ¡tico KraveAI

on:
  push:
    branches:
      - main

jobs:
  deploy:
    name: Despliegue en Raspberry Pi
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¡ Despliegue vÃ­a SSH
        uses: appleboy/ssh-action@v1
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: ${{ secrets.SSH_PORT }}
          script: |
            echo "ğŸ“¦ Iniciando despliegue KraveAI..."

            cd ~/kraveai-backend
            git fetch --all
            git reset --hard origin/main

            echo "ğŸ Activando entorno..."
            source env/bin/activate
            pip install -r requirements.txt

            echo "ğŸ” Reiniciando servicios..."
            sudo systemctl restart kraveai-python.service
            sudo systemctl restart crear-cuentas.service

            echo "ğŸŒ Verificando tÃºnel Cloudflare..."
            estado=$(systemctl is-active cloudflared.service)
            if [ "$estado" != "active" ]; then
              echo "TÃºnel inactivo, reiniciando..."
              sudo systemctl restart cloudflared.service
            else
              echo "TÃºnel Cloudflare ya estaba activo âœ…"
            fi

            echo "ğŸ©º Verificando estado del backend..."
            respuesta=$(curl -s http://localhost:8000/health || echo "")
            echo "Respuesta /health: $respuesta"

            if echo "$respuesta" | grep -q "\"status\": \"OK\""; then
              mensaje="âœ… *KraveAI actualizado con Ã©xito*\nğŸ“… $(date '+%Y-%m-%d %H:%M')\nğŸŸ¢ Backend responde en /health"
              status=0
            else
              mensaje="âš ï¸ *Error en despliegue KraveAI*\nğŸ“… $(date '+%Y-%m-%d %H:%M')\nğŸ”´ /health no respondiÃ³"
              status=1
            fi

            echo "ğŸ“¨ Enviando notificaciÃ³n Telegram..."
            curl -s -X POST https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendMessage \
              -d chat_id=${{ secrets.TELEGRAM_CHAT_ID }} \
              -d text="$mensaje" \
              -d parse_mode=Markdown

            exit $status
